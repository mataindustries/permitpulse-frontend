/* === PermitPulse frontend bootstrap (pages-first, workers.dev fallback) === */
(function(){
  // ---- Config (edit only if your workers.dev subdomain changes)
    const PAGES_API  = '/api/';
      const DIRECT_API = 'https://permitpulse-proxy.matasergio741.workers.dev/api/';

        // Optional: set both CTAs automatically if you tag them in HTML
          const STRIPE_LINK_PRO   = 'https://buy.stripe.com/4gM7sM6Ld86L0l94NA1wY07';
            const STRIPE_LINK_PROMO = 'https://buy.stripe.com/fZucN61qTev92thfse1wY08';

              // ---- Safe fetchers
                async function tryFetch(base, path, init) {
                    const url = base.replace(/\/?$/,'/') + String(path).replace(/^\//,'');
                        const res = await fetch(url, { headers: { accept: 'application/json' }, ...init });
                            if (!res.ok) throw new Error('HTTP ' + res.status + ' @ ' + url);
                                const ct = res.headers.get('content-type') || '';
                                    return ct.includes('application/json') ? res.json() : res.text();
                                      }
                                        async function api(path, init) {
                                            try { return await tryFetch(PAGES_API, path, init); }
                                                catch (e1) {
                                                      console.warn('[PP] Pages API failed — falling back:', e1.message || e1);
                                                            return await tryFetch(DIRECT_API, path, init);
                                                                }
                                                                  }

                                                                    // ---- GA helper
                                                                      function ga(evt, params){ try{ window.gtag && window.gtag('event', evt, params||{});}catch{} }

                                                                        // ---- Entitlements
                                                                          async function getPlan(){
                                                                              const email = localStorage.getItem('pp_email') || '';
                                                                                  if (!email) return 'free';
                                                                                      try {
                                                                                            const j = await api('/user?email='+encodeURIComponent(email));
                                                                                                  return (j && j.user && j.user.plan) || 'free';
                                                                                                      } catch { return 'free'; }
                                                                                                        }

                                                                                                          // ---- CSV (Pro only in UI)
                                                                                                            function wireCSV(city){
                                                                                                                const btn = document.querySelector('#btn-csv, [data-pp-csv]');
                                                                                                                    if (!btn) return;
                                                                                                                        getPlan().then(plan => {
                                                                                                                              if (plan === 'pro') {
                                                                                                                                      btn.style.display = '';
                                                                                                                                              btn.disabled = false;
                                                                                                                                                      btn.addEventListener('click', () => {
                                                                                                                                                                const limit = currentLimit();
                                                                                                                                                                          ga('csv_download', { city, rows: limit });
                                                                                                                                                                                    window.location.href = `/api/permits?city=${encodeURIComponent(city)}&limit=${limit}&csv=1`;
                                                                                                                                                                                            }, { once: true });
                                                                                                                                                                                                  } else {
                                                                                                                                                                                                          btn.style.display = 'none';
                                                                                                                                                                                                                }
                                                                                                                                                                                                                    });
                                                                                                                                                                                                                      }

                                                                                                                                                                                                                        // ---- Alerts (free gets 1 tracker, Pro gets 10)
                                                                                                                                                                                                                          function wireTracker(city){
                                                                                                                                                                                                                              const btn = document.querySelector('#btn-track, [data-pp-track]');
                                                                                                                                                                                                                                  if (!btn) return;
                                                                                                                                                                                                                                      btn.addEventListener('click', async () => {
                                                                                                                                                                                                                                            let email = (localStorage.getItem('pp_email') || '').trim();
                                                                                                                                                                                                                                                  if (!email) {
                                                                                                                                                                                                                                                          email = prompt('Enter your email to enable alerts:') || '';
                                                                                                                                                                                                                                                                  if (!email) return;
                                                                                                                                                                                                                                                                          localStorage.setItem('pp_email', email);
                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                      const resp = await api('/track', {
                                                                                                                                                                                                                                                                                              method:'POST',
                                                                                                                                                                                                                                                                                                      headers:{'content-type':'application/json'},
                                                                                                                                                                                                                                                                                                              body: JSON.stringify({ email, city })
                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                          if (resp && resp.ok) {
                                                                                                                                                                                                                                                                                                                                  alert(`Alerts enabled for ${city}. You’ll get emails when new permits drop.`);
                                                                                                                                                                                                                                                                                                                                          ga('tracker_add', { city });
                                                                                                                                                                                                                                                                                                                                                } else if (resp && resp.error === 'tracker_limit') {
                                                                                                                                                                                                                                                                                                                                                        alert('Tracker limit reached for your plan. Upgrade to Pro for up to 10.');
                                                                                                                                                                                                                                                                                                                                                              } else {
                                                                                                                                                                                                                                                                                                                                                                      alert('Could not enable alerts right now.');
                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                    // ---- City + table helpers (non-destructive; uses existing DOM if present)
                                                                                                                                                                                                                                                                                                                                                                                      function currentCityFromURL(){
                                                                                                                                                                                                                                                                                                                                                                                          const m = location.pathname.match(/\/city\/([^/]+)\/?/);
                                                                                                                                                                                                                                                                                                                                                                                              return m ? decodeURIComponent(m[1]) : '';
                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                  function currentLimit(){
                                                                                                                                                                                                                                                                                                                                                                                                      const sel = document.querySelector('#rows, #pp-rows, [data-pp-rows]');
                                                                                                                                                                                                                                                                                                                                                                                                          const v = sel && parseInt(sel.value, 10);
                                                                                                                                                                                                                                                                                                                                                                                                              return Number.isFinite(v) ? v : 25;
                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                  async function loadCity(city){
                                                                                                                                                                                                                                                                                                                                                                                                                      if (!city) return;
                                                                                                                                                                                                                                                                                                                                                                                                                          const limit = currentLimit();
                                                                                                                                                                                                                                                                                                                                                                                                                              const data = await api('/permits?city=' + encodeURIComponent(city) + '&limit=' + limit);
                                                                                                                                                                                                                                                                                                                                                                                                                                  // Emit a hook for any existing code to listen to:
                                                                                                                                                                                                                                                                                                                                                                                                                                      try { window.dispatchEvent(new CustomEvent('pp:data', { detail: { city, data } })); } catch {}
                                                                                                                                                                                                                                                                                                                                                                                                                                          // Fallback renderer if you include a simple table:
                                                                                                                                                                                                                                                                                                                                                                                                                                              renderIfSimpleTable(data);
                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                  function renderIfSimpleTable(data){
                                                                                                                                                                                                                                                                                                                                                                                                                                                      const tbody = document.querySelector('#pp-table-body');
                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (!tbody) return; // nothing to render into; keep silent
                                                                                                                                                                                                                                                                                                                                                                                                                                                              tbody.innerHTML = '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const items = (data && data.items) || [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (!items.length) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const empty = document.querySelector('#pp-empty');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (empty) empty.textContent = 'No results yet. Try again shortly.';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for (const it of items) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const tr = document.createElement('tr');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tr.innerHTML = `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <td>${escapeHtml(it.permit||'')}</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <td>${escapeHtml(it.address||'')}</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <td>${escapeHtml(it.status||'')}</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <td>${escapeHtml(it.filed_at||'')}</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <td>${escapeHtml(it.description||'')}</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          `;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tbody.appendChild(tr);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function escapeHtml(s){ return String(s||'').replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // ---- Wire CTAs automatically if tagged
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function wireCTAs(){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.querySelectorAll('[data-pp-cta="pro"]').forEach(a => { a.href = STRIPE_LINK_PRO; });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.querySelectorAll('[data-pp-cta="promo"]').forEach(a => { a.href = STRIPE_LINK_PROMO; });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // ---- Refresh + rows selector
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          function wireRefresh(city){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const btn = document.querySelector('#btn-refresh, [data-pp-refresh]');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (btn) btn.addEventListener('click', () => loadCity(city));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const sel = document.querySelector('#rows, #pp-rows, [data-pp-rows]');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (sel) sel.addEventListener('change', () => loadCity(city));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // ---- Boot
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.addEventListener('DOMContentLoaded', async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    wireCTAs();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // If this is a city page, load data + wire controls
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const city = currentCityFromURL();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (city) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      await loadCity(city);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            wireRefresh(city);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  wireCSV(city);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        wireTracker(city);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // track CTA clicks if you tag them
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.querySelectorAll('[data-pp-cta]').forEach(a => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          a.addEventListener('click', () => ga('cta_click', { variant: a.getAttribute('data-pp-cta') || 'pro' }));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // expose minimal API
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    window.PP_API = { api, getPlan };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    })();