<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Request a Free Permit CSV — PermitPulse</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-0S8S6156CV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-0S8S6156CV');
    function fireGAEvent(name){ gtag('event', name); }
    document.addEventListener('DOMContentLoaded', () => fireGAEvent('view_results'));
  </script>
</head>
<body class="bg-gray-50 text-gray-900">
  <main class="max-w-xl mx-auto p-6">
    <a href="/index.html" class="text-blue-600 hover:underline">&larr; Back</a>
    <h1 class="text-3xl font-bold mt-2 mb-3">Request a Free CSV</h1>
    <p class="text-gray-700 mb-6">Enter your email and filters. We’ll register a test alert and open a CSV of recent LADBS permits.</p>

    <form id="csvForm" class="space-y-4">
      <div>
        <label for="email" class="block text-sm font-medium">Email</label>
        <input id="email" name="email" type="email" required class="mt-1 w-full rounded border p-2" placeholder="you@example.com" />
      </div>
      <div>
        <label for="since_days" class="block text-sm font-medium">Since days</label>
        <input id="since_days" name="since_days" type="number" value="30" class="mt-1 w-full rounded border p-2" />
      </div>
      <div>
        <label for="min_value" class="block text-sm font-medium">Min value ($)</label>
        <input id="min_value" name="min_value" type="number" value="50000" class="mt-1 w-full rounded border p-2" />
      </div>
      <div>
        <label for="kw" class="block text-sm font-medium">Keywords</label>
        <input id="kw" name="kw" type="text" value="roof, solar, adu, new" class="mt-1 w-full rounded border p-2" />
      </div>
      <button class="bg-blue-600 text-white px-4 py-2 rounded" type="submit">Get CSV</button>
    </form>

    <p class="text-sm text-gray-600 mt-6">Tip: try narrowing keywords like <em>“solar”</em> or <em>“re-roof”</em> for tighter results.</p>
  </main>

  <script>
    document.getElementById('csvForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const since_days = document.getElementById('since_days').value || 30;
      const min_value  = document.getElementById('min_value').value || 50000;
      const kw        = document.getElementById('kw').value || 'roof, solar, adu, new';

      // Fire GA lead + digest events
      fireGAEvent('lead_captured');
      fireGAEvent('digest_requested');

      // Register a (test) alert
      const alertsUrl = `https://getpermitpulse.com/alerts/ladbs/test?email=${encodeURIComponent(email)}&since_days=${encodeURIComponent(since_days)}&min_value=${encodeURIComponent(min_value)}&kw=${encodeURIComponent(kw)}`;
      fetch(alertsUrl, { method: 'GET', mode: 'no-cors' }).catch(()=>{});

      // Open CSV
      const csvUrl = `https://getpermitpulse.com/csv/ladbs?since_days=${encodeURIComponent(since_days)}&min_value=${encodeURIComponent(min_value)}&kw=${encodeURIComponent(kw)}&limit=200`;
      fireGAEvent('csv_download'); // also covered by download link on topic pages
      window.open(csvUrl, '_blank');
    });
  </script>
</body>
</html>
