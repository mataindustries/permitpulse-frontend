<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Solicitar un CSV gratis — PermitPulse</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Ingrese su email y filtros. Registraremos una alerta de prueba y abriremos un CSV reciente de permisos de LADBS.">
  <link rel="canonical" href="https://getpermitpulse.com/es/free-csv.html">
  <link rel="alternate" hreflang="en" href="https://getpermitpulse.com/free-csv.html">
  <link rel="alternate" hreflang="es" href="https://getpermitpulse.com/es/free-csv.html">
  <link rel="alternate" hreflang="x-default" href="https://getpermitpulse.com/free-csv.html">

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-0S8S6156CV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-0S8S6156CV');
    function fireGAEvent(name){ gtag('event', name); }
    document.addEventListener('DOMContentLoaded', () => fireGAEvent('view_results'));
  </script>
</head>
<body class="bg-gray-50 text-gray-900">
  <main class="max-w-xl mx-auto p-6">
    <div class="flex items-center justify-between">
      <a href="/es/index.html" class="text-blue-600 hover:underline">&larr; Volver</a>
      <div id="lang-toggle" class="text-sm text-gray-600"></div>
    </div>

    <h1 class="text-3xl font-bold mt-2 mb-3">Solicitar un CSV gratis</h1>
    <p class="text-gray-700 mb-6">
      Ingrese su email y filtros. Registraremos una alerta de prueba y abriremos un CSV de permisos recientes de LADBS.
    </p>

    <form id="csvForm" class="space-y-4">
      <div>
        <label for="email" class="block text-sm font-medium">Email</label>
        <input id="email" name="email" type="email" required class="mt-1 w-full rounded border p-2" placeholder="usted@ejemplo.com" />
      </div>
      <div>
        <label for="since_days" class="block text-sm font-medium">Desde hace (días)</label>
        <input id="since_days" name="since_days" type="number" value="30" class="mt-1 w-full rounded border p-2" />
      </div>
      <div>
        <label for="min_value" class="block text-sm font-medium">Valor mínimo ($)</label>
        <input id="min_value" name="min_value" type="number" value="50000" class="mt-1 w-full rounded border p-2" />
      </div>
      <div>
        <label for="kw" class="block text-sm font-medium">Palabras clave</label>
        <input id="kw" name="kw" type="text" value="roof, solar, adu, new" class="mt-1 w-full rounded border p-2" />
      </div>
      <button class="bg-blue-600 text-white px-4 py-2 rounded" type="submit">Obtener CSV</button>
    </form>

    <p class="text-sm text-gray-600 mt-6">
      Sugerencia: pruebe palabras clave más precisas como <em>“solar”</em> o <em>“re-roof”</em> para resultados más ajustados.
    </p>
  </main>

  <script>
    // Fill language toggle (link to English counterpart)
    (function(){
      var el = document.getElementById('lang-toggle');
      if (!el) return;
      el.innerHTML = '<a class="underline" href="/free-csv.html">English</a> | <span>Español</span>';
    })();

    // GA helper fallback (if needed)
    window.dataLayer = window.dataLayer || [];
    window.gtag = window.gtag || function(){ dataLayer.push(arguments); };
    function fireGAEvent(name){ gtag('event', name); }

    document.getElementById('csvForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const email = document.getElementById('email').value.trim();
      const since_days = Number(document.getElementById('since_days').value || 30);
      const min_value  = Number(document.getElementById('min_value').value  || 50000);
      const kw         = document.getElementById('kw').value || 'roof, solar, adu, new';

      // Track lead
      fireGAEvent('lead_captured');
      fireGAEvent('digest_requested');

      // 1) Register welcome + alert via Worker
      try {
        await fetch('https://permit-mailer.matasergio741.workers.dev/freecsv', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({
            email, since_days, min_value, kw,
            utm: location.search.replace(/^\?/, ''),
            lang: 'es'
          })
        });
        fireGAEvent('alert_created');
      } catch (_) {
        // continue even if request fails
      }

      // 2) Open CSV in a new tab
      const csvUrl =
        `https://getpermitpulse.com/csv/ladbs` +
        `?since_days=${encodeURIComponent(since_days)}` +
        `&min_value=${encodeURIComponent(min_value)}` +
        `&kw=${encodeURIComponent(kw)}`;

      fireGAEvent('csv_download');
      window.open(csvUrl, '_blank');

      // 3) Optional thank-you (EN page for now)
      setTimeout(() => { location.href = '/thank-you/'; }, 300);
    });
  </script>
</body>
</html>
