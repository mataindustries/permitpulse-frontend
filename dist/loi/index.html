<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PermitPulse • Letter of Intent + Live Estimate</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,400;8..60,600&display=swap" rel="stylesheet">
  <meta name="description" content="Branded LoI (Letter of Intent) intake + real‑time estimator for PermitPulse. Polished, contract‑style, bilingual (EN/LA‑ES)." />
  <style>
    :root{
      --brand-navy:#0E2A3A; /* deep navy */
      --brand-blue:#2563EB; /* accent blue */
      --brand-teal:#10A6A6; /* secondary accent */
      --brand-gold:#E7B400; /* badge gold */
      --ink:#0f172a; /* slate-900 */
      --paper:#ffffff;
    }
    html,body{font-family:Inter,ui-sans-serif,system-ui,"Segoe UI",Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    .font-contract{font-family:"Source Serif 4",ui-serif,Georgia,serif;}
    .brand-gradient{background:linear-gradient(135deg,var(--brand-navy) 0%, #123B56 35%, var(--brand-blue) 100%);}    
    .card{box-shadow:0 1px 2px rgba(2,6,23,.06),0 8px 24px rgba(2,6,23,.08)}
    .ring-gradient{position:relative}
    .ring-gradient:before{content:"";position:absolute;inset:-1px;border-radius:16px;padding:1px;background:linear-gradient(180deg,rgba(255,255,255,.6),rgba(255,255,255,0)),linear-gradient(90deg,rgba(37,99,235,.35),rgba(16,166,166,.35));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude}/* Contract paper look */
.contract-wrap{background:var(--paper);position:relative;border-radius:18px;border:1px solid rgba(2,6,23,.08)}
.contract-wrap:after{ /* subtle blueprint grid watermark */
  content:"";position:absolute;inset:0;border-radius:18px;pointer-events:none;
  background:
    radial-gradient(1000px 600px at 110% -10%, rgba(37,99,235,.08), transparent 60%),
    repeating-linear-gradient(0deg, rgba(14,42,58,.05), rgba(14,42,58,.05) 1px, transparent 1px, transparent 24px),
    repeating-linear-gradient(90deg, rgba(14,42,58,.05), rgba(14,42,58,.05) 1px, transparent 1px, transparent 24px);
  mask-image: radial-gradient(100% 100% at 50% 50%, rgba(0,0,0,.65), transparent 85%);
}

 /* --- Clickability hotfix --- */
.ring-gradient:before{ pointer-events: none !important; z-index: 0; }
#loiForm{ position: relative; z-index: 1; }   
    
/* Print styles */
@media print{
  .no-print{display:none !important}
  body{background:var(--paper)}
  main{padding:0 !important}
  .contract-wrap{box-shadow:none;border:1px solid #cbd5e1;border-radius:8px}
  .page{page-break-inside:avoid}
}

  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!--
    ============================
    PermitPulse LoI + Estimator (Branded Pass)
    Single-file demo (vanilla JS + Tailwind CDN)
    © 2025 PermitPulseQUICK BRAND HOOKS:
- Colors: tweak CSS vars in :root
- Logo: replace inline SVG in header if you prefer an <img>
- Badge text: update #badgeOG below if needed

-->

  <!-- TOP NAV -->  <header class="no-print sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/60 bg-white/90 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
      <div class="w-10 h-10 rounded-xl brand-gradient flex items-center justify-center text-white font-bold">
        <!-- Inline logo mark -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <rect x="4" y="3" width="12" height="16" rx="2" stroke="currentColor" stroke-width="1.5"/>
          <path d="M8 9h4M8 12h6M8 15h5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M16 8c1.2-1.2 2.8-1.2 4 0 1.2 1.2 1.2 2.8 0 4-1.2 1.2-2.8 1.2-4 0-1-1-1-3 0-4z" stroke="currentColor" stroke-width="1.5"/>
        </svg>
      </div>
      <div class="mr-auto">
        <div class="text-sm uppercase tracking-wide text-slate-500">PermitPulse</div>
        <h1 class="text-lg font-semibold">Letter of Intent • Live Estimate</h1>
      </div>
      <div class="hidden md:flex items-center gap-2 text-sm">
        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-yellow-50 text-yellow-800 border border-yellow-200" id="badgeOG">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" class="-mt-0.5"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.5"/><path d="M7 12l3 3 7-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Outcome Guarantee
        </span>
      </div>
      <!-- Header actions -->
<div class="flex items-center gap-2">
  <!-- language -->
  <button id="lang-en" type="button" class="px-3 py-2 rounded-xl border">EN</button>
<button id="lang-es" type="button" class="px-3 py-2 rounded-xl border">ES</button>
<button id="shareBtn" type="button" class="px-3 py-2 rounded-xl text-white" style="background:linear-gradient(135deg,#2563EB,#10A6A6)">Share Quote</button>
</div>
    </div>
  </header>  <main class="max-w-6xl mx-auto px-4 py-8">
    <div class="grid lg:grid-cols-5 gap-7">
      <!-- LEFT: Form -->
      <section class="lg:col-span-3">
        <div class="bg-white card rounded-2xl border border-slate-200 ring-gradient">
          <div class="p-5 border-b border-slate-200 flex items-center justify-between">
            <div>
              <h2 class="text-xl font-semibold" data-i18n="form_title">Tell us what you need</h2>
              <p class="text-sm text-slate-600 mt-1" data-i18n="form_sub">Pick your tools and add‑ons. The estimate updates live.</p>
            </div>
            <div class="hidden sm:flex items-center gap-2 text-xs text-slate-500">
              <span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span>
              <span>Live calculator</span>
            </div>
          </div>
          <form id="loiForm" class="p-5 space-y-6">
            <!-- Contact -->
            <div class="grid sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium" data-i18n="label_name">Your name</label>
                <input name="name" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="John Smith" required />
              </div>
              <div>
                <label class="block text-sm font-medium" data-i18n="label_company">Company</label>
                <input name="company" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="PermitPulse" />
              </div>
              <div>
                <label class="block text-sm font-medium">Email</label>
                <input type="email" name="email" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="hello@getpermitpulse.com" required />
              </div>
              <div>
                <label class="block text-sm font-medium" data-i18n="label_phone">Phone</label>
                <input name="phone" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="(626) 555‑1234" />
              </div>
              <div>
                <label class="block text-sm font-medium" data-i18n="label_county">County / Area</label>
                <input name="county" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="Los Angeles County" />
              </div>
              <div>
                <label class="block text-sm font-medium" data-i18n="label_usecase">Use case</label>
                <select name="usecase" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-200">
                  <option>Roofing</option>
                  <option>Solar</option>
                  <option>HVAC</option>
                  <option>General Contractor</option>
                  <option>Other</option>
                </select>
              </div>
            </div><!-- Quantities -->
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium" data-i18n="label_seats">Seats</label>
            <input type="number" min="1" max="25" value="1" name="seats" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-200" />
            <p class="text-xs text-slate-500 mt-1" data-i18n="hint_seats">Includes 1 seat. Extras billed per seat.</p>
          </div>
          <div>
            <label class="block text-sm font-medium" data-i18n="label_regions">Regions</label>
            <select name="regions" multiple size="4" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-200">
              <option selected>LA City</option>
              <option>LA County (uninc.)</option>
              <option>Orange County</option>
              <option>San Bernardino County</option>
              <option>Riverside County</option>
              <option>San Diego County</option>
            </select>
            <p class="text-xs text-slate-500 mt-1" data-i18n="hint_regions">Base includes 1 region. Extras billed per region.</p>
          </div>
        </div>

        <!-- Add‑ons -->
        <div class="space-y-3">
          <div class="font-medium" data-i18n="addons_title">Add‑ons</div>
          <div id="addons" class="grid sm:grid-cols-2 gap-3"></div>
        </div>

            <div id="addons" class="space-y-3"></div>

        <!-- Target start / Notes -->
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium" data-i18n="label_start">Target start date</label>
            <input type="date" name="start" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-200" />
          </div>
          <div>
            <label class="block text-sm font-medium" data-i18n="label_lang">Preferred language</label>
            <select name="pref_lang" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-200">
              <option value="en" selected>English</option>
              <option value="es">Español (LA)</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium" data-i18n="label_notes">Notes</label>
          <textarea name="notes" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-200" rows="3" placeholder="Any special requests, integrations, or timelines?"></textarea>
        </div>

        <div class="flex flex-wrap gap-3">
          <button type="button" id="printBtn" class="no-print px-4 py-2 rounded-xl bg-slate-900 text-white" data-i18n="btn_print">Print / Save LoI (PDF)</button>
  
          <button type="submit" class="no-print px-4 py-2 rounded-xl text-white" style="background:linear-gradient(135deg,var(--brand-blue),var(--brand-teal))" data-i18n="btn_submit">Send to PermitPulse</button>
        </div>
        <p class="text-xs text-slate-500" data-i18n="legal_note">This is a non‑binding letter of intent and estimate. Final pricing may vary after scoping.</p>
      </form>
    </div>
  </section>

  <!-- RIGHT: Estimate / LoI Preview -->
  <aside class="lg:col-span-2 space-y-7">
    <div class="bg-white card rounded-2xl border border-slate-200 ring-gradient">
      <div class="p-5 border-b border-slate-200 flex items-center justify-between">
        <h2 class="text-xl font-semibold" data-i18n="est_title">Your estimate</h2>
        <span class="text-xs px-2 py-1 rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-200" id="bundleTag" hidden data-i18n="est_bundle">Bundle applied</span>
      </div>
      <div class="p-5 grid grid-cols-2 gap-4 items-end">
        <div>
          <div class="text-sm text-slate-500" data-i18n="est_monthly">Monthly</div>
          <div class="text-3xl font-semibold tracking-tight" id="monthlyTotal">$0</div>
        </div>
        <div>
          <div class="text-sm text-slate-500" data-i18n="est_onetime">One‑time</div>
          <div class="text-xl font-semibold tracking-tight" id="onetimeTotal">$0</div>
        </div>
        <div class="col-span-2 border-t border-slate-200 pt-4">
          <div class="text-sm font-medium mb-2" data-i18n="est_breakdown">Breakdown</div>
          <ul id="breakdown" class="space-y-1 text-sm"></ul>
        </div>
      </div>
    </div>

    <!-- CONTRACT‑STYLE PREVIEW -->
    <div class="contract-wrap card">
      <!-- Letterhead -->
      <div class="p-6 border-b border-slate-200 flex items-start gap-4">
        <div class="w-11 h-11 rounded-xl brand-gradient flex items-center justify-center text-white">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect x="4" y="3" width="12" height="16" rx="2" stroke="currentColor" stroke-width="1.5"/>
            <path d="M8 9h4M8 12h6M8 15h5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M16 8c1.2-1.2 2.8-1.2 4 0 1.2 1.2 1.2 2.8 0 4-1.2 1.2-2.8 1.2-4 0-1-1-1-3 0-4z" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </div>
        <div class="mr-auto">
          <div class="text-xs uppercase tracking-[0.14em] text-slate-500">PermitPulse</div>
          <div class="text-lg font-semibold">Letter of Intent</div>
          <div class="text-xs text-slate-500">getpermitpulse.com • hello@getpermitpulse.com</div>
        </div>
        <div class="text-right text-sm">
          <div class="text-slate-500" data-i18n="ref_label">Estimate Ref</div>
          <div class="font-semibold" id="refId">PP‑LOI</div>
          <div class="text-slate-500 mt-2" data-i18n="ref_date">Date</div>
          <div class="font-semibold" id="refDate">—</div>
        </div>
      </div>

      <!-- Reference amounts strip -->
      <div class="px-6 py-3 bg-slate-50/60 border-b border-slate-200 grid grid-cols-2 gap-4">
        <div class="text-sm"><span class="text-slate-500" data-i18n="est_monthly">Monthly</span> <span class="font-semibold" id="refMonthly">$0</span></div>
        <div class="text-sm"><span class="text-slate-500" data-i18n="est_onetime">One‑time</span> <span class="font-semibold" id="refOneTime">$0</span></div>
      </div>

      <!-- Body -->
      <div class="p-6 space-y-4 page">
        <div id="loiPreview" class="font-contract text-[0.985rem] leading-7"></div>

        <!-- Terms block -->
        <div class="mt-3 border-t border-slate-200 pt-4 text-sm leading-6" id="termsBlock">
          <div class="font-semibold mb-1" data-i18n="terms_title">Key Terms (non‑binding)</div>
          <ol class="list-decimal pl-5 space-y-1" id="termsList">
            <!-- filled by JS for i18n -->
          </ol>
        </div>

        <!-- Signature block -->
        <div class="grid sm:grid-cols-2 gap-6 mt-2">
          <div>
            <div class="h-12"></div>
            <div class="border-t border-slate-400"></div>
            <div class="text-xs text-slate-500 mt-1" data-i18n="sig_client">Client Signature • Name & Title • Date</div>
          </div>
          <div>
            <div class="h-12"></div>
            <div class="border-t border-slate-400"></div>
            <div class="text-xs text-slate-500 mt-1">PermitPulse • Authorized Signature • Date</div>
          </div>
        </div>
      </div>
    </div>
  </aside>
</div>

  </main>  <script>
    // ====== CONFIG ======
    const PRICING = {
      baseMonthly: 39, // Core plan monthly
      includedSeats: 1,
      includedRegions: 1,
      perExtraSeat: 15,
      perExtraRegion: 10,
      bundleDiscountPct: 10, // if >=3 monthly add‑ons selected
      addons: {
        radar: { label: {en:'Live Permit Radar', es:'Radar de Permisos en Vivo'}, monthly: 0, onetime: 0, featured:true, desc:{en:'Search & alerts', es:'Búsqueda y alertas'} },
        topPermits: { label: {en:'Top Permits Digest', es:'Resumen de Permisos Destacados'}, monthly: 9, onetime: 0, desc:{en:'Weekly email', es:'Correo semanal'} },
        smsPack: { label: {en:'SMS Pack (1,000/mo)', es:'Paquete SMS (1,000/mes)'}, monthly: 15, onetime: 0, desc:{en:'Outreach texting', es:'Mensajería de alcance'} },
        outcomeGuarantee: { label: {en:'Outcome Guarantee', es:'Garantía de Resultados'}, monthly: 99, onetime: 0, desc:{en:'1–2 booked estimates or refund', es:'1–2 estimados o reembolso'} },
        concierge: { label: {en:'Concierge Outreach', es:'Alcance Concierge'}, monthly: 199, onetime: 0, desc:{en:'We qualify & book', es:'Calificamos y agendamos'} },
        prioritySetup: { label: {en:'Priority Setup', es:'Configuración Prioritaria'}, monthly: 0, onetime: 149, desc:{en:'48‑hour onboarding', es:'Inicio en 48 horas'} },
        customIntegration: { label: {en:'Custom Integration', es:'Integración Personalizada'}, monthly: 0, onetime: 299, desc:{en:'CRM/API hookup', es:'Conexión con CRM/API'} },
      }
    };

    const FEATURES_ORDER = ['radar','topPermits','smsPack','outcomeGuarantee','concierge','prioritySetup','customIntegration'];

    const I18N = {
      en: {
        form_title: 'Tell us what you need',
        form_sub: 'Pick your tools and add‑ons. The estimate updates live.',
        label_name: 'Your name',
        label_company: 'Company',
        label_phone: 'Phone',
        label_county: 'County / Area',
        label_usecase: 'Use case',
        label_seats: 'Seats',
        hint_seats: 'Includes 1 seat. Extras billed per seat.',
        label_regions: 'Regions',
        hint_regions: 'Base includes 1 region. Extras billed per region.',
        addons_title: 'Add‑ons',
        label_start: 'Target start date',
        label_lang: 'Preferred language',
        label_notes: 'Notes',
        btn_print: 'Print / Save LoI (PDF)',
        btn_submit: 'Send to PermitPulse',
        btn_copy: 'Copy LoI text',
        legal_note: 'This is a non‑binding letter of intent and estimate. Final pricing may vary after scoping.',
        est_title: 'Your estimate',
        est_bundle: 'Bundle applied',
        est_monthly: 'Monthly',
        est_onetime: 'One‑time',
        est_breakdown: 'Breakdown',
        loi_title: 'Letter of Intent (Preview)',
        share_success: 'Shareable link copied to clipboard',
        copy_success: 'LoI copied to clipboard',
        submit_success: 'Thanks! We received your LoI.',
        ref_label: 'Estimate Ref',
        ref_date: 'Date',
        terms_title: 'Key Terms (non‑binding)',
        terms: [
          'Scope will be finalized after data source validation and kickoff.',
          'Monthly fees are billed at start of service; one‑time items at activation.',
          'Either party may terminate at any time; charges pro‑rated to the current month.',
          'Confidentiality: both parties agree to keep shared data and strategies private.',
          'This LoI expresses intent only and is not a binding agreement for services.'
        ],
        sig_client: 'Client Signature • Name & Title • Date',
      },
      es: {
        form_title: 'Cuéntanos qué necesitas',
        form_sub: 'Elige tus herramientas y complementos. El estimado se actualiza al instante.',
        label_name: 'Tu nombre',
        label_company: 'Empresa',
        label_phone: 'Teléfono',
        label_county: 'Condado / Área',
        label_usecase: 'Caso de uso',
        label_seats: 'Usuarios',
        hint_seats: 'Incluye 1 usuario. Extras con costo por usuario.',
        label_regions: 'Regiones',
        hint_regions: 'La base incluye 1 región. Extras con costo por región.',
        addons_title: 'Complementos',
        label_start: 'Fecha de inicio',
        label_lang: 'Idioma preferido',
        label_notes: 'Notas',
        btn_print: 'Imprimir / Guardar LoI (PDF)',
        btn_submit: 'Enviar a PermitPulse',
        btn_copy: 'Copiar texto del LoI',
        legal_note: 'Esta es una carta de intención sin obligación y un estimado. El precio final puede variar después del alcance.',
        est_title: 'Tu estimado',
        est_bundle: 'Paquete aplicado',
        est_monthly: 'Mensual',
        est_onetime: 'Pago único',
        est_breakdown: 'Desglose',
        loi_title: 'Carta de Intención (Vista previa)',
        share_success: 'Enlace para compartir copiado',
        copy_success: 'LoI copiado al portapapeles',
        submit_success: '¡Gracias! Recibimos tu LoI.',
        ref_label: 'Referencia',
        ref_date: 'Fecha',
        terms_title: 'Términos clave (no vinculantes)',
        terms: [
          'El alcance se definirá después de validar las fuentes de datos e iniciar el proyecto.',
          'Las tarifas mensuales se cobran al inicio; los pagos únicos al activarse.',
          'Cualquiera de las partes puede terminar en cualquier momento; cargos prorrateados al mes en curso.',
          'Confidencialidad: ambas partes mantendrán en privado los datos y estrategias compartidas.',
          'Este LoI expresa intención y no constituye un acuerdo vinculante de servicios.'
        ],
        sig_client: 'Firma del cliente • Nombre y cargo • Fecha',
      }
    };

    // ====== STATE ======
    let lang = 'en';
    const state = {
      name:'', company:'', email:'', phone:'', county:'', usecase:'Roofing', seats:1, regions:['LA City'], addons:{}, start:'', pref_lang:'en', notes:''
    };

    // ====== DOM ======
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function currency(n){ return `$${n.toLocaleString(undefined,{maximumFractionDigits:0})}`; }

    // Build add‑ons list
    function renderAddons(){
      const wrap = document.getElementById('addons');
      wrap.innerHTML = '';
      FEATURES_ORDER.forEach(key => {
        const cfg = PRICING.addons[key];
        const id = `addon_${key}`;
        const el = document.createElement('label');
        el.className = 'flex gap-3 items-start border border-slate-200 rounded-xl p-3 hover:border-slate-300 cursor-pointer';
        el.innerHTML = `
          <input type="checkbox" class="mt-1" id="${id}" data-key="${key}" />
          <div class="min-w-0">
            <div class="font-medium truncate">${cfg.label[lang]}</div>
            <div class="text-xs text-slate-600">${cfg.desc[lang]||''}</div>
            <div class="text-xs mt-1">${cfg.monthly?`<span class='font-medium'>${currency(cfg.monthly)}/mo</span>`:''} ${cfg.onetime?`<span class='text-slate-500'>+ ${currency(cfg.onetime)} one‑time</span>`:''}</div>
          </div>`;
        wrap.appendChild(el);
        const cb = el.querySelector('input');
        cb.checked = !!state.addons[key];
        cb.addEventListener('change', () => { state.addons[key] = cb.checked; update(); });
      });
    }

    // Translate UI
    function applyI18n(){
      $$('[data-i18n]').forEach(node => {
        const k = node.getAttribute('data-i18n');
        node.textContent = I18N[lang][k];
      });
      const termsList = $('#termsList');
      termsList.innerHTML = '';
      I18N[lang].terms.forEach(t=>{
        const li=document.createElement('li'); li.textContent = t; termsList.appendChild(li);
      })
      renderAddons();
      update();
    }

    // Read form into state
    function readForm(){
      const f = $('#loiForm');
      state.name = f.name.value.trim();
      state.company = f.company.value.trim();
      state.email = f.email.value.trim();
      state.phone = f.phone.value.trim();
      state.county = f.county.value.trim();
      state.usecase = f.usecase.value;
      state.seats = Math.max(1, parseInt(f.seats.value||'1',10));
      state.regions = Array.from(f.regions.selectedOptions).map(o=>o.value);
      state.start = f.start.value;
      state.pref_lang = f.pref_lang.value;
      state.notes = f.notes.value.trim();
    }
    
    function selectedMonthlyAddons(){
      return FEATURES_ORDER.filter(k => PRICING.addons[k].monthly && state.addons[k]);
    }

    // Price calculation
    function calculate(){
      const monthlyLines = [];
      const onetimeLines = [];

      // base
      let monthly = PRICING.baseMonthly;
      monthlyLines.push({label:`Core`, amount:PRICING.baseMonthly});

      // seats
      const extraSeats = Math.max(0, state.seats - PRICING.includedSeats);
      if (extraSeats>0){
        const amt = extraSeats * PRICING.perExtraSeat;
        monthly += amt; monthlyLines.push({label:`Extra seats ×${extraSeats}`, amount:amt});
      }

      // regions
      const extraRegions = Math.max(0, state.regions.length - PRICING.includedRegions);
      if (extraRegions>0){
        const amt = extraRegions * PRICING.perExtraRegion;
        monthly += amt; monthlyLines.push({label:`Extra regions ×${extraRegions}`, amount:amt});
      }

      // add‑ons
      let monthlyAddonCount = 0;
      FEATURES_ORDER.forEach(k => {
        if (!state.addons[k]) return;
        const a = PRICING.addons[k];
        if (a.monthly){ monthly += a.monthly; monthlyLines.push({label:a.label[lang], amount:a.monthly}); monthlyAddonCount++; }
        if (a.onetime){ onetimeLines.push({label:a.label[lang], amount:a.onetime}); }
      });

      // bundle discount
      let bundleApplied = false;
      if (monthlyAddonCount >= 3 && PRICING.bundleDiscountPct>0){
        const addOnMonthly = monthlyLines.slice(1).reduce((sum,l)=>sum+l.amount,0); // exclude core
        const discount = Math.round(addOnMonthly * (PRICING.bundleDiscountPct/100));
        if (discount>0){ monthly -= discount; monthlyLines.push({label:`Bundle (‑${PRICING.bundleDiscountPct}%)`, amount:-discount}); bundleApplied = true; }
      }

      const onetime = onetimeLines.reduce((s,l)=>s+l.amount,0);
      return { monthly, onetime, monthlyLines, onetimeLines, bundleApplied };
    }

     // Update totals + breakdown + preview
    function update(){
      readForm();
      const {monthly, onetime, monthlyLines, onetimeLines, bundleApplied} = calculate();
      $('#monthlyTotal').textContent = currency(monthly);
      $('#onetimeTotal').textContent = currency(onetime);
      const bd = $('#breakdown');
      bd.innerHTML = '';
      [...monthlyLines, ...onetimeLines].forEach(l => {
        const li = document.createElement('li');
        li.className = 'flex justify-between';
        li.innerHTML = `<span>${l.label}</span><span class="font-medium">${currency(l.amount)}</span>`;
        bd.appendChild(li);
      });
      $('#bundleTag').hidden = !bundleApplied;

      // Letterhead refs
      $('#refMonthly').textContent = currency(monthly);
      $('#refOneTime').textContent = currency(onetime);
      const now = new Date();
      $('#refDate').textContent = now.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
      $('#refId').textContent = `PP‑LOI‑${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;

      buildPreview(monthly, onetime, monthlyLines, onetimeLines);
      pushGA('quote_estimate_updated', {monthly, onetime});
    }

    function buildPreview(monthly, onetime, monthlyLines, onetimeLines){
      const today = new Date().toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
      const estLines = [...monthlyLines, ...onetimeLines].map(l => `• ${l.label}: ${currency(l.amount)}`).join('
');
      const selectedAddons = FEATURES_ORDER.filter(k=>state.addons[k]).map(k=>PRICING.addons[k].label[lang]);

      const text = lang==='en'
        ? `Date: ${today}

Letter of Intent – PermitPulse

From: ${state.name || '[Your name]'} (${state.company || 'Company'})
Email: ${state.email || ''}  Phone: ${state.phone || ''}
Area: ${state.county || ''}  Use case: ${state.usecase}

We intend to engage PermitPulse for the following configuration:
Seats: ${state.seats}
Regions: ${state.regions.join(', ') || '—'}
Add‑ons: ${selectedAddons.length? selectedAddons.join(', ') : 'None'}

Estimated Pricing (non‑binding):
${estLines}

Estimated monthly: ${currency(monthly)}
Estimated one‑time: ${currency(onetime)}
Target start: ${state.start || 'TBD'}
Preferred language: ${state.pref_lang==='es'?'Español (LA)':'English'}
Notes: ${state.notes || '—'}

This LoI is non‑binding. Final pricing to be confirmed after scoping.

Signature: __________________________
`
        : `Fecha: ${today}

Carta de Intención – PermitPulse

De: ${state.name || '[Tu nombre]'} (${state.company || 'Empresa'})
Correo: ${state.email || ''}  Teléfono: ${state.phone || ''}
Área: ${state.county || ''}  Caso de uso: ${state.usecase}

Tenemos la intención de contratar a PermitPulse con la siguiente configuración:
Usuarios: ${state.seats}
Regiones: ${state.regions.join(', ') || '—'}
Complementos: ${selectedAddons.length? selectedAddons.join(', ') : 'Ninguno'}

Estimado (no vinculante):
${estLines}

Mensual estimado: ${currency(monthly)}
Pago único estimado: ${currency(onetime)}
Inicio objetivo: ${state.start || 'Por definir'}
Idioma preferido: ${state.pref_lang==='es'?'Español (LA)':'Inglés'}
Notas: ${state.notes || '—'}

Este LoI no es vinculante. El precio final se confirmará después del alcance.

Firma: __________________________
`;

      const html = text
        .split('
')
        .map(line => line.trim()=== '' ? '<br />' : `<div>${escapeHtml(line)}</div>`)
        .join('');
      $('#loiPreview').innerHTML = html;
    }

    function escapeHtml(str){
      return str.replace(/[&<>\"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }

    // GA4 helper (no‑op if gtag missing)
    function pushGA(event, params){
      try {
        if (window.gtag) gtag('event', event, params);
        else if (window.dataLayer) window.dataLayer.push({event, ...params});
      } catch {}
    }

    // Shareable link (URL‑encoded state)
    function encodeStateToUrl(){
      const payload = {...state};
      const s = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(payload)))));
      const url = new URL(location.href);
      url.searchParams.set('q', s);
      return url.toString();
    }
    function decodeStateFromUrl(){
      const s = new URL(location.href).searchParams.get('q');
      if (!s) return;
      try{
        const json = JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(s)))));
        Object.assign(state, json);
        // populate form fields
        const f = $('#loiForm');
        f.name.value = state.name||''; f.company.value = state.company||''; f.email.value = state.email||'';
        f.phone.value = state.phone||''; f.county.value = state.county||''; f.usecase.value = state.usecase||'Roofing';
        f.seats.value = state.seats||1; state.regions = state.regions||['LA City'];
        Array.from(f.regions.options).forEach(o => { o.selected = state.regions.includes(o.value); });
        f.start.value = state.start||''; f.pref_lang.value = state.pref_lang||'en'; f.notes.value = state.notes||'';
      }catch(e){ console.warn('Decode failed', e); }
    }

    <<!-- RESCUE: safe event binding + re-init -->
<script>
  // helpers
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const bind = (sel, ev, fn)=>{ const el=$(sel); if(el){ el.addEventListener(ev, fn); return true; } return false; };

  function ensureAddonsUI() {
    const host = $('#addons');
    if (!host) return;
    // If nothing rendered (or i18n wiped it), inject a basic set
    if (!host.childElementCount) {
      host.innerHTML = `
        <label class="flex items-start gap-3">
          <input id="addon-radar" data-key="radar" type="checkbox" class="addon mt-1">
          <div><b>Permit Radar</b><div class="text-slate-500 text-sm">Live LADBS tracking</div></div>
        </label>
        <label class="flex items-start gap-3">
          <input id="addon-digest" data-key="digest" type="checkbox" class="addon mt-1">
          <div><b>Weekly Digest</b><div class="text-slate-500 text-sm">Email summary</div></div>
        </label>
        <label class="flex items-start gap-3">
          <input id="addon-sms" data-key="sms" type="checkbox" class="addon mt-1">
          <div><b>SMS Alerts</b><div class="text-slate-500 text-sm">High-value permits</div></div>
        </label>
        <label class="flex items-start gap-3">
          <input id="addon-guarantee" data-key="guarantee" type="checkbox" class="addon mt-1">
          <div><b>Outcome Guarantee</b><div class="text-slate-500 text-sm">1–2 booked estimates or refund</div></div>
        </label>
      `;
    }
    // Wire checkboxes into state
    $$('#addons input[type=checkbox]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        window.state = window.state || {};
        state.addons = state.addons || {};
        const k = cb.dataset.key || cb.id.replace('addon-','');
        state.addons[k] = cb.checked;
        try{ update(); }catch(_){}
      });
    });
  }

  // refresh totals frequently (covers selects, multiselects, text, toggles)
  ['input','change','click','keyup'].forEach(ev=>{
    bind('#loiForm', ev, ()=>{ try{ update(); }catch(_){} });
  });

  // submit -> KV (optional)
  bind('#loiForm','submit', async (e)=>{
    e.preventDefault();
    try{
      update();
      const res = await fetch('/api/loi', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ state, totals: calculate() })
      });
      alert(res.ok ? I18N[lang].submit_success : 'Submission failed');
      try{ pushGA('loi_submitted',{email: state.email}); }catch(_){}
    }catch(_){
      alert('Submission failed (offline demo). You can still print or share this LoI.');
    }
  });

  // print / share
  bind('#printBtn','click', ()=>{ try{ window.print(); pushGA('loi_printed',{});}catch(_){} });
  bind('#shareBtn','click', async ()=>{
    try{
      readForm();
      const url = encodeStateToUrl();
      await navigator.clipboard.writeText(url);
      alert(I18N[lang].share_success);
    }catch(_){}
  });

  // language toggles (re-render UI pieces)
  bind('#lang-en','click', ()=>{ lang='en'; applyI18n(); ensureAddonsUI(); try{ update(); }catch(_){} });
  bind('#lang-es','click', ()=>{ lang='es'; applyI18n(); ensureAddonsUI(); try{ update(); }catch(_){} });

  // boot
  (function boot(){
    try{ decodeStateFromUrl(); }catch(_){}
    try{ applyI18n(); }catch(_){}
    ensureAddonsUI();
    try{ update(); }catch(_){}

    // stealth default name
    const nameInput = $('input[name="name"]');
    if (nameInput && !nameInput.value.trim()) {
      nameInput.value = 'John Smith';
      if (typeof state !== 'undefined') state.name = 'John Smith';
    }
  })();
</script>

  <!-- OPTIONAL Worker stub remains identical to prior version; re‑use if needed. -->
</body>
</html>
